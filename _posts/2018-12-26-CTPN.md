---
layout: post
title:  CTPN原理与实现
subtitle: 
date: 2019-04-22 00:09:37 +08:00
author:     "VernonSong"
header-img: "img/post-bg-ctpn.jpg"
catalog: true
mathjax: true
tags:
    - 深度学习
    - 论文翻译
---

## 概述
虽然Faster R-CNN这样的网络在目标检测领域有这相当高的准确率，但直接放在文本检测任务中却并不能行的通，主要有两点原因：一是文本行的长度差异非常大的序列，没有明确定义的边界；二是目标检测一般只需要IoU大于0.5就可以判断出物体种类，但文本检测要求不能漏掉字符的任何一部分，才能准确识别出字符。因此，作者对Faster R-CNN进行改进，设计了专门进行文本行检测的CTPN（Connectionist Text Proposal Network）。

## CTPN
CTPN的思想非常简单：对于一种不认识的文字，如果只是单个字符，我们将会难以判断是否是文本，但如果是一整行字符，我们就会确信这是一行文字。因此，在CTPN中，先进行细粒度的文本块提议，然后根据该行的数个文本块判断其是不是一个文本行。

### 精细化区域建议网络（Fine-scale text proposals）
精细化区域建议网络是有RPN针对文本检测改进而来。由于文本行是一个包含了笔画，字符，单词等各个层次组件的序列，并且这些字符之间，甚至笔画之间都可能是分离的，因此，定位文本行的开始和结束位置是一件困难的事情。为了解决这个问题，作者提出使用细粒度的文本块提议，每个文本块的宽度固定为16（刚好是feat stride）。而文本块的的高度依然是像RPN那样将多尺度的Anchor进行边框回归后得到，在CTPN中，作者使用了从11到273之间（每次除以0.7）的10个尺度。

### 循环连接文本提议（Recurrent Connectionist Text Proposals）
由于文本具有明显的序列特征，CNN网络后得到的feature map中，每个位置的信息较为孤立，在文本识别领域中，主流网络通过加入RNN层来提高识别准确率。受此启发，CTPN也加入BLSTM，将每一行的信息结合起来，更好的判断每一个区域是否是文本行中的一部分。

![](\img\in-post\post-ctpn.png)

### 生成文本行粒度的边框
目前得到是细粒度的文本框，还需将属于同一个文本行的文本框拼接起来。拼接的规则很简单：如果文本框$B_i$与$B_j$互为左右邻居，则将其拼接。邻居的要求是：

1. $B_i$与$B_j$在左或右方向上水平距离最小
2. 该距离小于50像素
3. 垂直IOU大于0.7

为实现这一算法，可以先按每个文本框的水平位置进行排序，然后计算每个文本框之间的垂直IOU和距离，得到有效距离矩阵，再通过三角矩阵取分离其前向距离和后向距离，得到前向邻居和后向邻居，再进行遍历。

### 边缘细化（Side-refinement）
由于CTPN没有在水平方向做边框的回归，因此得到的文本框左右位置会有偏差，为了能更精确地定位，再对网络加上水平方向的回归分支：

$$
\begin{align*}
o=(x_{size}-c_x^a)/w^a
o*=(x_{side}^*-c_x^a)/w^a
\end{align*}
$$

其中$x_{side}$是左右边界文本框的边界x坐标，$x_{side}^*$是x轴的真实边界坐标，$w^a$为细粒度文本框宽度（16）。

虽然加入此步骤可以略微提高文本框水平精度，但是实际应用中，这对最后的文本识别不会造成什么影响，此步骤可以省略不做。

### 其它细节
CTPN的模型与常见的目标检测类似，都是多任务学习，其中分类任务损失为cross entropy loss，边框回归（垂直方向）为smooth L1 loss，边缘细化（水平方向）为L2 loss。并将与实际边框IoU大于0.7的作为正样本，小于0.5的作为负样本。训练时，从anchors中选择一个正负样本为1:1的mini-batch来计算分类损失。

CTPN的设计主要针对水平文本行，但文本行倾斜角度较大时，RNN层很难将文本行的信息结合起来，同时也要重新设计文本行粒度的文本框的生成算法。

## 实现

[Tensorflow CTPN实现](https://github.com/VernonSong/CTPN)

## 参考
[Detecting Text in Natural Image with Connectionist Text Proposal Network](https://arxiv.org/abs/1609.03605)




